{% extends "barra.html" %}
{% load static %}

{% block title %}Alumnos · Pomi{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'styles/alumnos.css' %}">
{% endblock %}

{% block content %}
<section class="alumnos" aria-labelledby="alumnosTitle">
  <!-- Encabezado / acciones -->
  <header class="alumnos__actions" aria-label="Acciones de alumnos">
    <div class="actions__left">
      <h1 id="alumnosTitle" class="alumnos__title">
        Alumnos
        <span class="title__shine" aria-hidden="true"></span>
      </h1>
      <p class="alumnos__subtitle">{{ page_subtitle|default:"Gestión de estudiantes" }}</p>
    </div>

    <div class="actions__right">
      <form method="get" class="search" role="search" aria-label="Buscar alumnos">
        <i data-lucide="search" class="search__icon"></i>
        <input name="q" class="search__input" placeholder="Buscar por código, nombre, apellido o carrera…" value="{{ request.GET.q|default:'' }}">
      </form>

      <button type="button" class="btn" id="btnExportCSV" title="Exportar CSV">
        <i data-lucide="download"></i>
        CSV
      </button>

      <button type="button" class="btn btn--primary" id="btnAddStudent" title="Agregar alumno">
        <i data-lucide="user-plus"></i>
        Agregar
      </button>

      <button type="button" class="btn btn--special" id="btnBulkLoad" title="Carga masiva">
        <i data-lucide="upload"></i>
        Carga masiva
      </button>
    </div>
  </header>

  <!-- Mensajes de Django -->
  {% if messages %}
    <div class="messages" role="status" aria-live="polite">
      {% for m in messages %}
        <div class="msg msg--{{ m.tags }}">{{ m }}</div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Estadísticas rápidas -->
  <div class="stats">
    <div class="stat">
      <div class="stat__icon"><i data-lucide="users"></i></div>
      <div class="stat__body">
        <div class="stat__value">{{ total_alumnos|default:0 }}</div>
        <div class="stat__label">Total estudiantes</div>
      </div>
    </div>
    <div class="stat">
      <div class="stat__icon stat__icon--ok"><i data-lucide="check-circle-2"></i></div>
      <div class="stat__body">
        <div class="stat__value">{{ alumnos.paginator.count|default:0 }}</div>
        <div class="stat__label">Resultados encontrados</div>
      </div>
    </div>
  </div>

  <!-- Tabla -->
  <div class="card table-card">
    <div class="table-wrap">
      <table class="table" aria-label="Listado de alumnos">
        <thead>
          <tr>
            <th>Código UPC</th>
            <th>Nombres</th>
            <th>Apellidos</th>
            <th>Carrera</th>
            <th>Estado</th>
            <th class="col-actions">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for alumno in alumnos %}
          <tr class="row-animate"
              data-code="{{ alumno.code_upc }}"
              data-first="{{ alumno.first_names|escape }}"
              data-full="{{ alumno.full_names|escape }}"
              data-career="{{ alumno.career|default:''|escape }}"
              data-active="{{ alumno.is_active|yesno:'true,false' }}">
            <td class="mono">{{ alumno.code_upc }}</td>
            <td>{{ alumno.first_names }}</td>
            <td>{{ alumno.full_names }}</td>
            <td class="soft">{{ alumno.career|default:"—" }}</td>
            <td>
              {% if alumno.is_active %}
                <span class="pill pill--ok"><i data-lucide="check-circle-2"></i> Activo</span>
              {% else %}
                <span class="pill pill--off"><i data-lucide="x-circle"></i> Inactivo</span>
              {% endif %}
            </td>
            <td class="actions">
              <button type="button" class="icon-btn js-edit" title="Editar alumno">
                <i data-lucide="edit-2"></i>
              </button>
              <button type="button" class="icon-btn icon-btn--danger js-delete" title="Eliminar alumno">
                <i data-lucide="trash-2"></i>
              </button>
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="6" class="empty">
              <i data-lucide="inbox"></i>
              No hay estudiantes registrados.
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- Paginación -->
    {% if alumnos.has_other_pages %}
    <div class="pagination">
      <div class="pagination__info">
        Mostrando {{ alumnos.start_index }} - {{ alumnos.end_index }} de {{ alumnos.paginator.count }} alumnos
      </div>
      <div class="pagination__controls">
        {% if alumnos.has_previous %}
          <a href="?page=1{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-btn" title="Primera página">
            <i data-lucide="chevrons-left"></i>
          </a>
          <a href="?page={{ alumnos.previous_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-btn" title="Página anterior">
            <i data-lucide="chevron-left"></i>
          </a>
        {% else %}
          <span class="page-btn page-btn--disabled"><i data-lucide="chevrons-left"></i></span>
          <span class="page-btn page-btn--disabled"><i data-lucide="chevron-left"></i></span>
        {% endif %}

        <span class="page-current">Página {{ alumnos.number }} de {{ alumnos.paginator.num_pages }}</span>

        {% if alumnos.has_next %}
          <a href="?page={{ alumnos.next_page_number }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-btn" title="Página siguiente">
            <i data-lucide="chevron-right"></i>
          </a>
          <a href="?page={{ alumnos.paginator.num_pages }}{% if request.GET.q %}&q={{ request.GET.q }}{% endif %}" class="page-btn" title="Última página">
            <i data-lucide="chevrons-right"></i>
          </a>
        {% else %}
          <span class="page-btn page-btn--disabled"><i data-lucide="chevron-right"></i></span>
          <span class="page-btn page-btn--disabled"><i data-lucide="chevrons-right"></i></span>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </div>
</section>

<!-- Modal Agregar/Editar Alumno -->
<div class="modal" id="modalStudent" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal__panel">
    <header class="modal__head">
      <div>
        <h3 id="studentTitle">Agregar estudiante</h3>
        <small id="studentSubtitle" class="muted">Complete los datos del estudiante</small>
      </div>
      <button class="modal__close" type="button" data-close>
        <i data-lucide="x"></i>
      </button>
    </header>

    <form method="post" class="form" id="formStudent">
      {% csrf_token %}
      <input type="hidden" name="action" id="fldAction" value="create">

      <div class="grid">
        <div class="field field--full">
          <label>Código UPC <span>*</span></label>
          <input type="text" name="code_upc" id="fldCodeUPC" class="input" placeholder="Ej: U202012345" required maxlength="10">
        </div>

        <div class="field">
          <label>Nombres <span>*</span></label>
          <input type="text" name="first_names" id="fldFirstNames" class="input" placeholder="Ej: Juan Carlos" required maxlength="100">
        </div>

        <div class="field">
          <label>Apellidos <span>*</span></label>
          <input type="text" name="full_names" id="fldFullNames" class="input" placeholder="Ej: Pérez García" required maxlength="100">
        </div>

        <div class="field field--full">
          <label>Carrera</label>
          <input type="text" name="career" id="fldCareer" class="input" placeholder="Ej: Ingeniería de Sistemas" maxlength="50">
        </div>

        <div class="field field--full">
          <label class="checkbox">
            <input type="checkbox" name="is_active" id="fldIsActive" checked>
            <span class="checkbox__mark"></span>
            <span class="checkbox__label">Estudiante activo</span>
          </label>
        </div>
      </div>

      <footer class="modal__foot">
        <button type="button" class="btn" data-close>Cancelar</button>
        <button type="submit" class="btn btn--primary">
          <span class="btn__inner"><i data-lucide="save"></i> Guardar</span>
          <span class="btn__spin" aria-hidden="true"></span>
        </button>
      </footer>
    </form>
  </div>
</div>

<!-- Modal Eliminar -->
<div class="modal" id="modalDelete" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal__panel modal__panel--sm">
    <header class="modal__head">
      <div>
        <h3>Eliminar estudiante</h3>
        <small class="muted">Esta acción no se puede deshacer</small>
      </div>
      <button class="modal__close" type="button" data-close>
        <i data-lucide="x"></i>
      </button>
    </header>

    <form method="post" id="formDelete">
      {% csrf_token %}
      <input type="hidden" name="action" value="delete">
      <input type="hidden" name="code_upc" id="fldDeleteCode">

      <div class="modal__content">
        <div class="alert alert--warning">
          <i data-lucide="alert-triangle"></i>
          <div>
            <strong>¿Está seguro?</strong>
            <p>Se eliminará el estudiante <strong id="deleteStudentName"></strong>. Esta acción es permanente.</p>
          </div>
        </div>
      </div>

      <footer class="modal__foot">
        <button type="button" class="btn" data-close>Cancelar</button>
        <button type="submit" class="btn btn--danger">
          <i data-lucide="trash-2"></i>
          Eliminar
        </button>
      </footer>
    </form>
  </div>
</div>

<!-- Modal Carga Masiva -->
<div class="modal" id="modalBulk" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal__panel modal__panel--lg">
    <header class="modal__head">
      <div>
        <h3>Carga masiva de estudiantes</h3>
        <small class="muted">Seleccione el tipo de carga</small>
      </div>
      <button class="modal__close" type="button" data-close>
        <i data-lucide="x"></i>
      </button>
    </header>

    <div class="modal__content" id="bulkStep1">
      <div class="bulk-options">
        <div class="bulk-card" data-mode="replace">
          <div class="bulk-card__icon bulk-card__icon--replace">
            <i data-lucide="refresh-cw"></i>
          </div>
          <h4 class="bulk-card__title">Actualizar toda la base de datos</h4>
          <p class="bulk-card__desc">Reemplaza todos los registros existentes con los datos del archivo</p>
          <button type="button" class="btn btn--outline js-select-mode">
            <i data-lucide="arrow-right"></i>
            Seleccionar
          </button>
        </div>

        <div class="bulk-card" data-mode="add">
          <div class="bulk-card__icon bulk-card__icon--add">
            <i data-lucide="user-plus"></i>
          </div>
          <h4 class="bulk-card__title">Agregar alumnos</h4>
          <p class="bulk-card__desc">Añade nuevos estudiantes sin eliminar los existentes</p>
          <button type="button" class="btn btn--outline js-select-mode">
            <i data-lucide="arrow-right"></i>
            Seleccionar
          </button>
        </div>
      </div>
    </div>

    <div class="modal__content hidden" id="bulkStep2">
      <button type="button" class="btn btn--back" id="btnBackToBulk">
        <i data-lucide="arrow-left"></i>
        Volver
      </button>

      <div class="bulk-info">
        <div class="info-box">
          <div class="info-box__head">
            <i data-lucide="info"></i>
            <strong>Formato requerido</strong>
          </div>
          <div class="info-box__body">
            <p>El archivo debe contener las siguientes columnas en este orden exacto:</p>
            <ul class="info-list">
              <li><code>code_upc</code> - Código UPC del alumno (obligatorio, único)</li>
              <li><code>first_names</code> - Nombres del alumno (obligatorio)</li>
              <li><code>full_names</code> - Apellidos del alumno (obligatorio)</li>
              <li><code>career</code> - Carrera del alumno (opcional)</li>
              <li><code>is_active</code> - Estado: true/false, 1/0, si/no, activo/inactivo (opcional, por defecto: true)</li>
            </ul>
          </div>
        </div>

        <div class="template-download">
          <i data-lucide="download"></i>
          <div>
            <strong>¿No tienes una plantilla?</strong>
            <p>Descarga el formato correcto para facilitar la carga</p>
          </div>
          <a href="{% url 'pomi:download_template' %}" class="btn btn--outline">
            <i data-lucide="file-down"></i>
            Descargar plantilla
          </a>
        </div>
      </div>

      <div class="upload-area" id="uploadArea">
        <input type="file" id="fileInput" accept=".csv,.xlsx" hidden>
        <div class="upload-area__icon">
          <i data-lucide="upload-cloud"></i>
        </div>
        <h4 class="upload-area__title">Arrastra tu archivo aquí</h4>
        <p class="upload-area__desc">o haz clic para seleccionar</p>
        <div class="upload-area__meta">
          <span class="badge">CSV</span>
          <span class="badge">XLSX</span>
          <span class="muted">· Máximo 10MB</span>
        </div>
      </div>

      <div class="upload-preview hidden" id="uploadPreview">
        <div class="preview-file">
          <div class="preview-file__icon">
            <i data-lucide="file-text"></i>
          </div>
          <div class="preview-file__info">
            <strong id="fileName"></strong>
            <small id="fileSize" class="muted"></small>
          </div>
          <button type="button" class="icon-btn icon-btn--danger" id="btnRemoveFile">
            <i data-lucide="x"></i>
          </button>
        </div>

        <div class="preview-results hidden" id="previewResults">
          <!-- Se llenará dinámicamente con los resultados -->
        </div>

        <button type="button" class="btn btn--primary btn--full hidden" id="btnConfirmUpload">
          <i data-lucide="check"></i>
          Confirmar y cargar datos
        </button>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  try { lucide.createIcons(); } catch (_) {}

  const $ = (s, el=document) => el.querySelector(s);
  const $$ = (s, el=document) => [...el.querySelectorAll(s)];

  // --- Modal helpers ---
  const open = (m) => { m?.classList.add('is-open'); m?.setAttribute('aria-hidden','false'); };
  const close = (m) => { m?.classList.remove('is-open'); m?.setAttribute('aria-hidden','true'); };

  const modalStudent = $('#modalStudent');
  const modalDelete = $('#modalDelete');
  const modalBulk = $('#modalBulk');

  // --- Agregar estudiante ---
  $('#btnAddStudent')?.addEventListener('click', () => {
    $('#studentTitle').textContent = 'Agregar estudiante';
    $('#studentSubtitle').textContent = 'Complete los datos del estudiante';
    $('#fldAction').value = 'create';
    $('#formStudent').reset();
    $('#fldIsActive').checked = true;
    $('#fldCodeUPC').readOnly = false;
    open(modalStudent);
    setTimeout(() => $('#fldCodeUPC')?.focus(), 80);
  });

  // --- Editar estudiante ---
  $$('.js-edit').forEach(btn => {
    btn.addEventListener('click', () => {
      const row = btn.closest('tr');
      const code = row?.dataset.code || '';
      const first = row?.dataset.first || '';
      const full = row?.dataset.full || '';
      const career = row?.dataset.career || '';
      const active = row?.dataset.active === 'true';

      $('#studentTitle').textContent = 'Editar estudiante';
      $('#studentSubtitle').textContent = `Código: ${code}`;
      $('#fldAction').value = 'update';
      $('#fldCodeUPC').value = code;
      $('#fldCodeUPC').readOnly = true;
      $('#fldFirstNames').value = first;
      $('#fldFullNames').value = full;
      $('#fldCareer').value = career;
      $('#fldIsActive').checked = active;

      open(modalStudent);
      setTimeout(() => $('#fldFirstNames')?.focus(), 80);
    });
  });

  // --- Eliminar estudiante ---
  $$('.js-delete').forEach(btn => {
    btn.addEventListener('click', () => {
      const row = btn.closest('tr');
      const code = row?.dataset.code || '';
      const first = row?.dataset.first || '';
      const full = row?.dataset.full || '';

      $('#fldDeleteCode').value = code;
      $('#deleteStudentName').textContent = `${first} ${full} (${code})`;

      open(modalDelete);
    });
  });

  // --- Exportar CSV ---
  $('#btnExportCSV')?.addEventListener('click', () => {
    window.location.href = "{% url 'pomi:alumnos_csv' %}";
  });

  // --- Carga masiva ---
  let currentMode = 'add';
  let selectedFile = null;

  $('#btnBulkLoad')?.addEventListener('click', () => {
    $('#bulkStep1').classList.remove('hidden');
    $('#bulkStep2').classList.add('hidden');
    $('#uploadPreview').classList.add('hidden');
    $('#uploadArea').classList.remove('hidden');
    selectedFile = null;
    open(modalBulk);
  });

  $$('.js-select-mode').forEach(btn => {
    btn.addEventListener('click', () => {
      const card = btn.closest('.bulk-card');
      currentMode = card?.dataset.mode || 'add';
      $('#bulkStep1').classList.add('hidden');
      $('#bulkStep2').classList.remove('hidden');
      lucide.createIcons();
    });
  });

  $('#btnBackToBulk')?.addEventListener('click', () => {
    $('#bulkStep1').classList.remove('hidden');
    $('#bulkStep2').classList.add('hidden');
  });

  // --- Upload area ---
  const uploadArea = $('#uploadArea');
  const fileInput = $('#fileInput');
  const uploadPreview = $('#uploadPreview');

  uploadArea?.addEventListener('click', () => fileInput?.click());

  uploadArea?.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragging');
  });

  uploadArea?.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragging');
  });

  uploadArea?.addEventListener('drop', (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragging');
    const file = e.dataTransfer?.files[0];
    if (file) handleFile(file);
  });

  fileInput?.addEventListener('change', (e) => {
    const file = e.target?.files[0];
    if (file) handleFile(file);
  });

  $('#btnRemoveFile')?.addEventListener('click', () => {
    selectedFile = null;
    fileInput.value = '';
    uploadArea.classList.remove('hidden');
    uploadPreview.classList.add('hidden');
    $('#previewResults').classList.add('hidden');
    $('#btnConfirmUpload').classList.add('hidden');
  });

  function handleFile(file) {
    if (!file) return;

    const ext = file.name.split('.').pop().toLowerCase();
    if (!['csv', 'xlsx'].includes(ext)) {
      alert('Solo se permiten archivos CSV o XLSX');
      return;
    }

    if (file.size > 10 * 1024 * 1024) {
      alert('El archivo no debe superar 10MB');
      return;
    }

    selectedFile = file;
    $('#fileName').textContent = file.name;
    $('#fileSize').textContent = formatBytes(file.size);
    
    uploadArea.classList.add('hidden');
    uploadPreview.classList.remove('hidden');

    // Procesar archivo
    processFile(file);
  }

  async function processFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('mode', currentMode);

    try {
      const response = await fetch("{% url 'pomi:process_bulk_file' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        showPreview(result.data);
      } else {
        alert('Error: ' + result.error);
      }
    } catch (error) {
      alert('Error al procesar el archivo: ' + error);
    }
  }

  function showPreview(data) {
    const preview = $('#previewResults');
    const validCount = data.filter(r => r.errors.length === 0).length;
    const errorCount = data.filter(r => r.errors.length > 0).length;

    let html = `
      <div class="preview-stats">
        <div class="preview-stat preview-stat--ok">
          <i data-lucide="check-circle-2"></i>
          <span>${validCount} válidos</span>
        </div>
        <div class="preview-stat preview-stat--error">
          <i data-lucide="alert-circle"></i>
          <span>${errorCount} con errores</span>
        </div>
      </div>
    `;

    if (errorCount > 0) {
      html += '<div class="preview-errors"><h5>Errores encontrados:</h5><ul>';
      data.forEach((row, idx) => {
        if (row.errors.length > 0) {
          html += `<li><strong>Fila ${idx + 2}:</strong> ${row.errors.join(', ')}</li>`;
        }
      });
      html += '</ul></div>';
    }

    preview.innerHTML = html;
    preview.classList.remove('hidden');
    
    if (validCount > 0) {
      $('#btnConfirmUpload').classList.remove('hidden');
    }

    lucide.createIcons();
  }

  $('#btnConfirmUpload')?.addEventListener('click', async () => {
    if (!selectedFile) return;

    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('mode', currentMode);

    try {
      const response = await fetch("{% url 'pomi:process_bulk_file' %}", {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}'
        },
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        // Confirmar carga
        const confirmResponse = await fetch("{% url 'pomi:confirm_bulk_load' %}", {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
          },
          body: JSON.stringify({
            mode: currentMode,
            data: result.data
          })
        });

        const confirmResult = await confirmResponse.json();

        if (confirmResult.success) {
          alert(`¡Éxito! ${confirmResult.created} estudiante(s) cargado(s)`);
          window.location.reload();
        } else {
          alert('Error: ' + confirmResult.error);
        }
      }
    } catch (error) {
      alert('Error al confirmar la carga: ' + error);
    }
  });

  function formatBytes(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  // --- Cerrar modales ---
  $$('[data-close]').forEach(b => b.addEventListener('click', (e) => close(e.target.closest('.modal'))));
  [modalStudent, modalDelete, modalBulk].forEach(m => {
    m?.addEventListener('click', (e) => { if (e.target === m) close(m); });
  });

  // --- Animación de filas ---
  const io = new IntersectionObserver((entries) => {
    entries.forEach(en => {
      if (en.isIntersecting) {
        en.target.classList.add('in');
        io.unobserve(en.target);
      }
    });
  }, { threshold: .1 });
  $$('.row-animate').forEach(r => io.observe(r));
});
</script>
{% endblock %}